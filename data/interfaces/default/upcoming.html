<%inherit file="base.html" />
<%!
        import mylar
%>

<%def name="headerIncludes()">
	<style>
		#rejected_matches_table tbody tr:hover {
			background-color: #4a4a4a;
			cursor: pointer;
		}
		#rejected_matches_table tbody tr {
			transition: background-color 0.2s ease;
		}
	</style>
	<div id="subhead_container">
		<div id="subhead_menu">
			<a href="#" id="menu_link_scan" onclick="doAjaxCall('forceSearch',$(this))" data-success="Checking for wanted issues successful" data-error="Error checking wanted issues">Force Check Tier-1</a>
		</div>
	</div>
</%def>


<%def name="body()">
        <input type="hidden" id="page_name" value="upcoming" />
	<div class="title">
		<h1 class="clearfix"><img src="${icons['icon_wanted']}" alt="Wanted Issues"/>Wanted Issues (<span id="wanted_count"></span>)</h1>
	</div>

        <span style="vertical-align: middle;"><small>Tier-1 cutoff length: <span id="cutoff">${mylar.CONFIG.SEARCH_TIER_CUTOFF}</span> days</small></span>

        <div id="checkboxControls" name="checkboxControls" style="float: right; vertical-align: middle; margin: 5px 3px 3px 3px;">
         <div style="padding-bottom: 5px;">
             <label for="Wanted" class="checkbox inline Wanted" id="wantedlabel" style="display:none;"><input type="checkbox" name="Wanted" id="Wanted" checked="checked" /> Wanted: <b><span id="wantedcount"></span></b></label>
             <label for="Tier1" class="checkbox inline Tier1" id="tier1label" style="display:none;"><input type="checkbox" name="Tier1" id="Tier1" checked="checked" />Tier-1: <b><span id="tier1count"></span></b></label>
             <label for="Tier2" class="checkbox inline Tier2" id="tier2label" style="display:none;"><input type="checkbox" name="Tier2" id="Tier2" checked="checked" />Tier-2: <b><span id="tier2count"></span></b></label>
             <label for="Snatched" class="checkbox inline Snatched" id="snatchedlabel" style="display:none;"><input type="checkbox" name="Snatched" id="Snatched" checked="checked" /> Snatched: <b><span id="snatchedcount"></span></b></label>
             <label for="Storyarcs" class="checkbox inline Storyarcs" id="storyarcslabel" style="display:none;"><input type="checkbox" name="Storyarcs" id="Storyarcs" checked="checked" /> StoryArcs: <b><span id="storyarcscount"></span></b></label>
             <label for="Failed" class="checkbox inline Failed" id="failedlabel" style="display:none;"><input type="checkbox" name="Failed" id="Failed" checked="checked" /> Failed: <b><span id="failedcount"></span></b></label>
         </div>
        </div>

        <div class="table_wrapper" id="wanted_table_wrapper">
          <form action="mark_the_issues" method="get" id="markissues" name="markissues">
            <div style="position:absolute;float:left;display:none;" id="markissue">Mark selected issues as
                <select name="action" id="mark_issues" onChange="mark_the_issues()" data-success="selected issues marked">
                                <option disabled="disabled" selected="selected">Choose...</option>
                                <option value="Wanted">Wanted</option>
                                <option value="Skipped">Skipped</option>
                                <option value="Downloaded">Downloaded</option>
                                <option value="Archived">Archived</option>
                                <option value="Ignored">Ignored</option>
                                <option value="OppositeTier">Opposite Tier</option>
                </select>
                <input type="hidden" value="Go">
            </div>

            <small style="float: right; vertical-align: middle;">Date shown in SearchTier is when the issue was added to the Wanted list</small>
	    <table class="display select" id="wanted_table">
		<thead>
			<tr>
                                <th id="select"><input type="checkbox" name="select_all" value="1" id="wanted-select-all" class="checkbox" /></th>
				<th id="comicname">Comic</th>
				<th id="issuenumber">#</th>
				<th id="reldate">Release Date</th>
				<th id="status">Status</th>
                                <th id="tier">SearchTier</th>
			</tr>
		</thead>
		<tbody>
		</tbody>
	    </table>
	</form>
        </div>
        </br>

        <!-- Rejected Matches Dialog -->
        <div id="rejected_matches_dialog" title="Rejected Search Matches" style="display:none;">
            <div id="rejected_matches_loading" style="text-align: center; padding: 20px;">
                <p>Loading rejected matches...</p>
            </div>
            <div id="rejected_matches_content" style="display:none;">
                <p id="rejected_matches_empty" style="display:none; text-align: center; padding: 20px;">
                    No rejected matches found for this issue.
                </p>
                <div style="max-height: 500px; overflow-y: auto; overflow-x: auto;">
                    <table id="rejected_matches_table" style="width: 100%;">
                        <thead style="position: sticky; top: 0; background-color: #fff; z-index: 10;">
                            <tr>
                                <th>Title</th>
                                <th>Provider</th>
                                <th>Size</th>
                                <th>Kind</th>
                                <th>Date</th>
                                <th>Reason</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="rejected_matches_table_body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="title">
                <h1 class="clearfix"><img src="${icons['icon_upcoming']}" alt="Upcoming Issues"/>Upcoming Issues</h1>
        </div>

        <div id="tabs">
                <ul>
                        <li><a href="#tabs-1">This Week's Upcoming (${upcoming_count})</a></li>
                        <li><a href="#tabs-2">Future Auto-Wants</a></li>
                        <li><a href="#tabs-3">Incomplete / Mismatched CV (${mismatched_count})</a></li>
                </ul>

        <div id="tabs-1">
          <div class="table_wrapper">
            <table class="display_no_select" id="upcoming_table">
                %if upcoming:
                    <thead>
                            <tr>
                                    <th id="comicname">Comic</th>
                                    <th id="issuenumber">Issue</th>
                                    <th id="reldate">Release Date</th>
                                    <th id="status">Status</th>
                            </tr>
                    </thead>
                    <tbody>
                    %for upcome in upcoming:
                            <tr class="gradeZ">
                                    <td id="comicname"><a href="comicDetails?ComicID=${upcome['ComicID']}">${upcome['ComicName']}</a></td>
                                    <td id="issuenumber">${upcome['IssueNumber']}</td>
                                    <td id="reldate">${upcome['IssueDate']}</td>
                                    <td id="status">${upcome['Status']}</td>
                            </tr>
                    %endfor
                %else:
                  <tr><td align="center" width="100%"> no upcoming data to display</td></tr>
                %endif
               </tbody>
            </table>
          </div>
          <center><small>Issues listed here are not on CV yet <a href="https://github.com/mylar3/mylar3/wiki/Where-Mylar-gets-the-metadata-from" target="_new">(read more)</a></small></center>
        </div>
        <div id="tabs-2">
           <a id="menu_link_edit" href="future_check">Force Check Availability</a>
           <div style="float:right;text-align:right;font-size:20px;font-weight:bold;" title="manually add issue to auto-want list">+</div>
           <div class="table_wrapper">
                <table class="display_no_select" id="upcoming_nodata_table">
                %if future_nodata_upcoming:
                    <thead>
                        <tr>
                                <th id="delcolumn"></th>
                                <th id="comicname">Comic</th>
                                <th id="issuenumber">Issue</th>
                                <th id="reldate">Release Date</th>
                                <th id="status">Status</th>
                        </tr>
                </thead>
                <tbody>
                    %for f_nodata in future_nodata_upcoming:
                            <tr class="gradeZ">
                                    <td id="delcolumn">
                                    <%
                                        comic_name_escaped = f_nodata['ComicName'].replace("'", "\\'").replace('"', '\\"')
                                        issue_date_escaped = f_nodata['IssueDate'].replace("'", "\\'").replace('"', '\\"') if f_nodata['IssueDate'] else ''
                                    %>
                                    <a href="upcoming#tabs-2" title="Delete series from auto-Want list" onclick="doAjaxCall('removeautowant?comicname=${comic_name_escaped |u}&release=${issue_date_escaped |u}',$(this),'table')" data-success="${comic_name_escaped} has been removed from the auto-want list"><img src="images/skipped_icon.png" height="25" width="25" class="highqual" /></a>
                                    </td>
                                    %if f_nodata['ComicID'] is not None:
                                        <td id="comicname"><a href="comicDetails?ComicID=${f_nodata['ComicID']}">${f_nodata['ComicName']}</a></td>
                                    %else:
                                        <td id="comicname">${f_nodata['ComicName']}</td>
                                    %endif
                                    <td id="issuenumber">${f_nodata['IssueNumber']}</td>
                                    <td id="reldate">${f_nodata['IssueDate']}</td>
                                    <td id="status">${f_nodata['Status']}</td>
                            </tr>
                    %endfor
                %else:
                  <div align="center">No items currently being watched</div>
                %endif
               </tbody>
               </table>
            </div>
        </div>
        <div id="tabs-3">
          <div class="table_wrapper">
            <table class="display_no_select" id="mismatched_table">
                %if mismatched:
                    <thead>
                            <tr>
                                    <th id="comicname">Comic</th>
                                    <th id="issuenumber">Issue</th>
                                    <th id="misinfo">Reason for Mismatch (CV - Pull)</th>
                                    <th id="weekinfo">Pull-list</th>
                            </tr>
                    </thead>
                    <tbody>
                    %for mis in mismatched:
                            <%
                               if mis['status'] == 'Mismatched':
                                   grade = "Z"
                               else:
                                   grade = "Y"
                            %>
                            <tr class="grade${grade}">
                                    <td id="comicname"><a href="comicDetails?ComicID=${mis['comicid']}">${mis['comicname']}</a></td>
                                    <td id="issuenumber">${mis['issuenumber']}</td>
                                    <td id="misinfo">${mis['mismatch_type']}</td>
                                    <td id="weekinfo"><a href="pullist?week=${mis['pullweek']}&year=${mis['pullyear']}#${mis['comicname']}_${mis['issuenumber']}">${mis['pullyear']}-${mis['pullweek']}</a></td>
                            </tr>
                    %endfor
                    </tbody>
                %else:
                  <tr><td align="center" width="100%">No mismatched data</td></tr>
                %endif
            </table>
          </div>
          <center><small>Mismatches can possibly indicate: the dates are incorrect btwn CV & Mylar, an incorrect volume, or an incorrect booktype</br>
          A <b>Recreate Pullist</b> for the given week (click in column) may correct stale dates</small></center>
        </div>
      </div>
</%def>

<%def name="headIncludes()">
	<link rel="stylesheet" href="interfaces/${interface}/css/data_table.css">
</%def>

<%def name="javascriptIncludes()">
	<script src="js/libs/jquery.dataTables.min.js"></script>
        <script>
        function mark_the_issues(){
            var action=$("#mark_issues option:selected").val();
            var checks = document.getElementsByName("issueid[]");
            var checkboxesChecked = [];
            for (var i=0; i<checks.length; i++) {
                if (checks[i].checked) {
                    // console.log(checks[i].value);
                    checkboxesChecked.push(checks[i].value);
                }
            }
            // console.log(checkboxesChecked);
            $.when($.ajax({
                 type: "GET",
                 url: "markissues",
                 data: { action: action, issueids: checkboxesChecked },
                 success: function(response) {
                    obj = JSON.parse(response);
                 },
                 error: function(data)
                     {
                       alert('ERROR'+data.responseText);
                     },
            })).done(function(data) {
                 //reload_table();
            });
        }

        function search_the_issues() {
            var checks = document.getElementsByName("issueid[]");
            var checkboxesChecked = [];
            for (var i=0; i<checks.length; i++) {
                if (checks[i].checked) {
                    // console.log(checks[i].value);
                    checkboxesChecked.push(checks[i].value);
                }
            }

            $.when($.ajax({
                type: "GET",
                url: "forceSearch",
                data: { issueIds: checkboxesChecked },
                traditional : true,
                success: function(response) {
                    obj = JSON.parse(response);
                 },
                 error: function(data)
                     {
                       alert('ERROR'+data.responseText);
                     },
            })).done(function(data) {
                 reload_table();
                 fc = document.getElementById("menu_link_scan");
                 fc.getElementsByClassName('ui-button-text')[0].innerText = "Force Check Tier-1";
            });
        }

       function count_checks(){
            var checks = document.getElementsByName("issueid[]");
            cc = document.getElementById("markissue");
            fc = document.getElementById("menu_link_scan");
            var checkfound = false;
            for (var i=0; i<checks.length; i++) {
                if (checks[i].checked) {
                    checkfound = true;
                    break;
                }
            }
            if (checkfound == true){
                cc.style.display = "block";
                fc.onclick = function(){ search_the_issues() };
                fc.getElementsByClassName('ui-button-text')[0].innerText = "Force Check Selected";
            } else {
                cc.style.display = "none";
                fc.onclick = function(){ doAjaxCall('forceSearch',this) };
                fc.getElementsByClassName('ui-button-text')[0].innerText = "Force Check Tier-1";
            }
        }

        function retrieve_filters() {
            filters = []
            filters.push({"name": "Wanted", "value": document.getElementById("Wanted").checked });
            filters.push({"name": "Snatched", "value": document.getElementById("Snatched").checked });
            filters.push({"name": "Storyarcs", "value": document.getElementById("Storyarcs").checked });
            filters.push({"name": "Tier1", "value": document.getElementById("Tier1").checked });
            filters.push({"name": "Tier2", "value": document.getElementById("Tier2").checked });
            filters.push({"name": "Failed", "value": document.getElementById("Failed").checked });
            return JSON.stringify(filters);
        }

        function update_filters() {
            $.when($.ajax({
                 type: "GET",
                 url: "update_upcoming_filters",
                 success: function(response) {
                    obj = JSON.parse(response);
                    if (obj['status'] == 'success'){
                        obj_filters = obj['filters'];
                        wantedcount = document.getElementById("wantedlabel");
                        if (parseInt(obj_filters['wanted'], 10) > 0){
                            wantedcount.style.display = "inline";
                            document.getElementById("wantedcount").innerHTML = obj_filters['wanted'];
                        } else if (parseInt(obj_filters['wanted'], 10) <= 0) {
                            document.getElementById("wantedcount").innerHTML = "";
                            wantedcount.style.display = "none";
                        }
                        tier1count = document.getElementById("tier1label");
                        if (parseInt(obj_filters['tier1'], 10) > 0){
                            tier1count.style.display = "inline";
                            document.getElementById("tier1count").innerHTML = obj_filters['tier1'];
                        } else if (parseInt(obj_filters['tier1'], 10) <= 0) {
                            document.getElementById("tier1count").innerHTML = "";
                            tier1count.style.display = "none";
                        }
                        tier2count = document.getElementById("tier2label");
                        if (parseInt(obj_filters['tier2'], 10) > 0){
                            tier2count.style.display = "inline";
                            document.getElementById("tier2count").innerHTML = obj_filters['tier2'];
                        } else if (parseInt(obj_filters['tier2'], 10) <= 0) {
                            document.getElementById("tier2count").innerHTML = "";
                            tier2count.style.display = "none";
                        }
                        snatchedcount = document.getElementById("snatchedlabel");
                        if (parseInt(obj_filters['snatched'], 10) > 0){
                            snatchedcount.style.display = "inline";
                            document.getElementById("snatchedcount").innerHTML = obj_filters['snatched'];
                        } else if (parseInt(obj_filters['snatched'], 10) <= 0) {
                            document.getElementById("snatchedcount").innerHTML = "";
                            snatchedcount.style.display = "none";
                        }
                        failedcount = document.getElementById("failedlabel");
                        if (parseInt(obj_filters['failed'], 10) > 0){
                            failedcount.style.display = "inline";
                            document.getElementById("failedcount").innerHTML = obj_filters['failed'];
                        } else if (parseInt(obj_filters['failed'], 10) <= 0) {
                            document.getElementById("failedcount").innerHTML = "";
                            failedcount.style.display = "none";
                        }
                        storyarcscount = document.getElementById("storyarcslabel");
                        if (parseInt(obj_filters['storyarcs'], 10) > 0){
                            storyarcscount.style.display = "inline";
                            document.getElementById("storyarcscount").innerHTML = obj_filters['storyarcs'];
                        } else if (parseInt(obj_filters['storyarcs'], 10) <= 0) {
                            document.getElementById("storyarcscount").innerHTML = "";
                            storyarcsdcount.style.display = "none";
                        }
                        document.getElementById("wanted_count").innerHTML = parseInt(obj_filters['tier1'],10) + parseInt(obj_filters['tier2'],10);
                    }
                 },
                 error: function(data)
                     {
                       alert('ERROR'+data.responseText);
                     },
            })).done(function(data) {
                 console.log('finished counts updated.');
            });           
        }

	function initThisPage() {
            $(function() {
                     $( "#tabs" ).tabs();
            });
            initActions();
            $.fn.DataTable.ext.pager.numbers_length = 5;
            $('#wanted_table').dataTable({
                "preDrawCallback": function (settings){
                    pageScrollPos = $('#wanted_table div.datatables_scrollBody').scrollTop();
                    // make sure the filter counts are up-to-date
                    update_filters();
                    // reset the mark_issues dropdown so it won't keep the last selection
                    dropdown = document.getElementById("mark_issues");
                    dropdown.selectedIndex = 0;
                    document.getElementById("markissue").style.display = "none";
                    document.getElementById("wanted-select-all").checked = false;
                },
                "sDom": '<"clear"f><"clear"lp><"clear">rt<"clear"ip>',
		"destroy": true,
		"processing": true,
		"serverSide": true,
                "ajax": {
                    "data": function (d) {
                        d.filters = retrieve_filters();
                    }
                },
		"ajaxSource": 'loadupcoming',
                "columnDefs": [
                    {
                        "sortable": false,
                        "targets": [ 0 ],
                        "visible": true,
                        "render":function (data,type,full,meta) {
                           return '<input type="checkbox" name="issueid[]" value="' + $('<div/>').text(full[3]).html() + '" />';
                        }
                    },
                    {
                        "sortable": true,
                        "targets": [ 1 ],
                        "visible": true,
                        "render":function (data,type,full) {
                           if(typeof(full[8]) === "undefined" || full[8] === null){
                               linkit = '<a href="comicDetails?ComicID='+full[5]+'">'+full[0]+'</a>';
                           } else {
                               // storyarcs
                               if (full[10] == "oneoff"){
                                   // exists only in storyarcs
                                   linkit = '<a href="detailStoryArc?StoryArcID='+full[8]+'&StoryArcName='+full[7]+'">[<b>'+full[7]+'</b>] '+full[0]+'</a>';
                               } else {
                                   // exists in both watchlist & storyarcs
                                   linkit = '<b>[<a href="detailStoryArc?StoryArcID='+full[8]+'&StoryArcName='+full[7]+'">'+full[7]+'] </b><a href="comicDetails?ComicID='+full[5]+'"> '+full[0]+'</a>';
                               }
                           }
                           return linkit;
                        }
                     },
                    {
                        "sortable": true,
                        "targets": [ 2 ],
                        "visible": true,
                        "render":function (data,type,full) {
                           return full[1];
                        }
                    },
                    {
                        "sortable": true,
                        "targets": [ 3 ],
                        "visible": true,
                        "render":function (data,type,full) {
                            return full[2];
                        }
                    },
                    {
                        "sortable": true,
                        "targets": [ 4 ],
                        "visible": true,
                        "render":function (data,type,full) {
                            var status = full[6];
                            var has_ddl_info = full[13] !== undefined ? full[13] : true; // Default to true if not set (for backwards compatibility)
                            
                            // If status is Snatched and no ddl_info exists, add warning icon
                            if (status === 'Snatched' && !has_ddl_info) {
                                return status + ' <img src="images/cross.png" height="16" width="16" style="margin-left: 5px; vertical-align: middle;" title="Download failed - no download information available. Please mark as Wanted and search again." />';
                            }
                            return status;
                        }
                    },
                    {
                        "sortable": true,
                        "targets": [ 5 ],
                        "visible": true,
                        "render":function (data,type,full){
                            // Add magnifying glass icon for Wanted issues or Snatched issues without ddl_info
                            var tierText = full[4];
                            var issueId = full[3];
                            var rejectedCount = full[12] || 0; // Get rejected matches count (default to 0 if undefined)
                            var has_ddl_info = full[13] !== undefined ? full[13] : true; // Default to true if not set (for backwards compatibility)
                            var status = full[6];
                            
                            // Show rejected matches link for Wanted issues, or Snatched issues without ddl_info
                            if (issueId && (status === "Wanted" || (status === "Snatched" && !has_ddl_info))) {
                                var iconHtml = '<img src="images/search.png" height="16" width="16" style="margin-left: 5px; vertical-align: middle;" />';
                                if (rejectedCount > 0) {
                                    // Add count badge
                                    iconHtml += '<span style="background-color: #ff6b6b; color: white; border-radius: 50%; padding: 1px 5px; font-size: 10px; font-weight: bold; margin-left: 2px; vertical-align: super;">' + rejectedCount + '</span>';
                                }
                                var titleText = rejectedCount > 0 ? 'View rejected search matches (' + rejectedCount + ' available)' : 'View rejected search matches';
                                if (status === "Snatched" && !has_ddl_info) {
                                    titleText = 'Download failed - try alternative download from rejected matches' + (rejectedCount > 0 ? ' (' + rejectedCount + ' available)' : '');
                                }
                                tierText += ' <a href="#" class="rejected-matches-link" data-issueid="' + $('<div/>').text(issueId).html() + '" title="' + titleText + '">' + iconHtml + '</a>';
                            }
                            return tierText;
                        }
                    },
                    ],
                "paginationType": "simple_numbers",
                "aaSorting": [[3, 'desc']],
                "displayLength": 25,
                "stateSave": true,
                "lengthMenu": [[10, 15, 25, 50, 100, 200, -1], [10, 15, 25, 50, 100, 200, 'All' ]],
                "language": {
                     "search":"Filter:",
                     "lengthMenu":"Show _MENU_ items per page",
                     "emptyTable": "No history information available",
                     "info":"Showing _START_ to _END_ of _TOTAL_ items",
                     "infoEmpty":"Showing 0 to 0 of 0 items",
                     "infoFiltered":"(filtered from _MAX_ total items)"
                },
                "rowCallback": function (nRow, aData, iDisplayIndex, iDisplayIndexFull) {
                     if (aData[6] === "Wanted") {
                        if (aData[4].includes("1st")){
                            $('td', nRow).closest('tr').addClass(aData[6]).addClass('gradeX');
                        } else {
                            $('td', nRow).closest('tr').addClass(aData[6]).addClass('gradeT2');
                        }
                     } else if (aData[6] === "Snatched") {
                        $('td', nRow).closest('tr').addClass(aData[6]).addClass('gradeC');
                     } else if (aData[6] === "Failed"){
                        $('td', nRow).closest('tr').addClass(aData[6]).addClass('gradeF');
                     } else {
                        $('td', nRow).closest('tr').addClass(aData[6]).addClass('gradeZ');
                     }
                     nRow.children[0].id = 'select';
                     nRow.children[1].id = 'comicname';
                     nRow.children[2].id = 'issuenumber';
                     nRow.children[3].id = 'reldate';
                     nRow.children[4].id = 'status';
                     nRow.children[5].id = 'tier';
                     return nRow;
                },
                "drawCallback": function (o) {
                     // Jump to top of page
                     $('#wanted_table div.dataTables_scrollBody').scrollTop(pageScrollPos);
                },
                "serverData": function ( sSource, aoData, fnCallback ) {
                    /* Add some extra data to the sender */
                    aoData.push({"name": "filters", "value": retrieve_filters() });
                    $.getJSON(sSource, aoData, function (json) {
                            fnCallback(json)
                    });
                },
                "fnInitComplete": function(oSettings, json)
                {
                },
            });
	};

    var lastChecked = null;

	$(document).ready(function() {
            initThisPage();
            var tables = $('table.display').DataTable();
            $(document).on("change", '#checkboxControls input[type="checkbox"]', function() {
            //$('#checkboxControls input[type="checkbox"]').onchange(function(){
                tables.ajax.reload();
            });

            // wanted table
            // Handle click on "Select all" control
            $('#wanted-select-all').on('click', function(){
                // Get all rows with search applied
                var rows = tables.rows({ 'search': 'applied' }).nodes();
               // Check/uncheck checkboxes for all rows in the table
               $('input[type="checkbox"]', rows).prop('checked', this.checked);
               count_checks();
            });

            $('#wanted_table tbody').on('click', 'input[type="checkbox"]', function(e){
                var chkboxes = Array.from(document.getElementsByName("issueid[]").values());

                if (!lastChecked) {
                    lastChecked = this;
                } else {
                    if (e.shiftKey) {
                        var start = chkboxes.indexOf(lastChecked);
                        var end = chkboxes.indexOf(this);

                        var positive = start < end;

                        for (var i = (positive ? start: end );
                        (positive ? i <= end : i <= start); i++) {
                            chkboxes[i].checked = lastChecked.checked;
                        }
                        lastChecked = null;
                    }
                    else {
                        lastChecked = this;
                    }
                }
            });

            // Handle click on checkbox to set state of "Select all" control
            $('#wanted_table tbody').on('change', 'input[type="checkbox"]', function(){
                count_checks();

                // If checkbox is not checked
                if(!this.checked){
                    var el = $('#wanted_table-select-all').get(0);
                    // If "Select all" control is checked and has 'indeterminate' property
                    if(el && el.checked && ('indeterminate' in el)){
                        // Set visual state of "Select all" control
                        // as 'indeterminate'
                        el.indeterminate = true;
                    }
                }
            });
            // Handle form submission event
            $('#markissues').on('submit', function(e){
               var form = this;

               // Iterate over all checkboxes in the table
               tables.$('input[type="checkbox"]').each(function(){
                  // If checkbox doesn't exist in DOM
                  if(!$.contains(document, this)){
                     // If checkbox is checked
                     if(this.checked){
                        // Create a hidden element
                        $(form).append(
                           $('<input>')
                              .attr('type', 'hidden')
                              .attr('name', this.name)
                              .val(this.value)
                        );
                     }
                  }
               });
            });

            // Initialize rejected matches dialog
            $("#rejected_matches_dialog").dialog({
                autoOpen: false,
                width: "80%",
                height: 650,
                maxHeight: 650,
                modal: true,
                resizable: true
            });

            // Handle click on magnifying glass icon
            $(document).on('click', '.rejected-matches-link', function(e) {
                e.preventDefault();
                var issueId = $(this).data('issueid');
                if (!issueId) {
                    alert('Error: Issue ID not found');
                    return false;
                }
                
                // Show loading
                $('#rejected_matches_loading').show();
                $('#rejected_matches_content').hide();
                $('#rejected_matches_empty').hide();
                
                // Open dialog
                $("#rejected_matches_dialog").dialog("open");
                
                // Fetch rejected matches
                $.getJSON('get_rejected_matches', {IssueID: issueId}, function(data) {
                    $('#rejected_matches_loading').hide();
                    
                    if (data.status === 'success' && data.matches && data.matches.length > 0) {
                        // Populate table
                        var tbody = $('#rejected_matches_table_body');
                        tbody.empty();
                        
                        $.each(data.matches, function(index, match) {
                            // Use unique identifier (nzbid + link) instead of index
                            var matchNzbId = match.nzbid || '';
                            var matchLink = match.link || '';
                            var matchNzbIdEscaped = $('<div/>').text(matchNzbId).html();
                            var matchLinkEscaped = $('<div/>').text(matchLink).html();
                            
                            var row = '<tr>' +
                                '<td>' + $('<div/>').text(match.title || 'Unknown').html() + '</td>' +
                                '<td>' + $('<div/>').text(match.provider || 'Unknown').html() + '</td>' +
                                '<td>' + $('<div/>').text(match.size || 'Unknown').html() + '</td>' +
                                '<td>' + $('<div/>').text(match.kind || 'Unknown').html() + '</td>' +
                                '<td>' + $('<div/>').text(match.pubdate || '').html() + '</td>' +
                                '<td>' + $('<div/>').text(match.reason || 'Unknown reason').html() + '</td>' +
                                '<td><button class="download-rejected-btn" data-issueid="' + $('<div/>').text(issueId).html() + '" data-nzbid="' + matchNzbIdEscaped + '" data-link="' + matchLinkEscaped + '">Download</button></td>' +
                                '</tr>';
                            tbody.append(row);
                        });
                        
                        $('#rejected_matches_content').show();
                    } else {
                        // No matches found
                        $('#rejected_matches_empty').show();
                    }
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    $('#rejected_matches_loading').hide();
                    alert('Error loading rejected matches: ' + textStatus);
                });
                
                return false;
            });

            // Handle download button click
            $(document).on('click', '.download-rejected-btn', function(e) {
                e.preventDefault();
                var issueId = $(this).data('issueid');
                var matchNzbId = $(this).data('nzbid');
                var matchLink = $(this).data('link');
                var btn = $(this);
                
                // Disable button and show loading
                btn.prop('disabled', true).text('Adding...');
                
                $.getJSON('select_rejected_match', {
                    IssueID: issueId,
                    nzbid: matchNzbId,
                    link: matchLink
                }, function(data) {
                    if (data.status === 'success') {
                        // Success - close dialog silently
                        $("#rejected_matches_dialog").dialog("close");
                        
                        // Reload the table to reflect changes
                        if ($.fn.dataTable.isDataTable('#wanted_table')) {
                            $('#wanted_table').DataTable().ajax.reload(null, false);
                        }
                    } else {
                        // Error - show alert and allow retry
                        alert('Error: ' + (data.message || 'Failed to add to download queue'));
                        btn.prop('disabled', false).text('Download');
                    }
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    alert('Error: ' + textStatus);
                    btn.prop('disabled', false).text('Download');
                });
                
                return false;
            });
	});
	</script>
</%def>
